name: Update Version

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - staging
      - dev

jobs:
  update-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run update version script
        run: |
          chmod +x .github/scripts/update_version.sh
          .github/scripts/update_version.sh

      - name: Get new version
        run: |
          NEW_VERSION=$(grep -oP 'VERSION = "\K[0-9]+\.[0-9]+\.[0-9]+' "app/config.py")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Push changes
        run: |
          git add .
          git commit -m "[CHORES] bump version to $NEW_VERSION"
          git push

      - name: Create Git Tag
        uses: anothrNick/github-tag-action@1.71.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CUSTOM_TAG: ${{ env.NEW_VERSION }}
